# مخطط قاعدة البيانات لتطبيق "وسّط" (Wassit)

## نظرة عامة

هذا المستند يوضح بنية قاعدة البيانات لتطبيق وسّط (Wassit) باستخدام Prisma ORM مع MySQL كقاعدة بيانات. يحتوي المخطط على العلاقات بين الجداول والحقول المطلوبة لتشغيل التطبيق.

## التكنولوجيا المستخدمة

- **نوع قاعدة البيانات**: MySQL
- **ORM**: Prisma
- **لغة البرمجة للتعامل مع قاعدة البيانات**: Node.js / TypeScript

## المخطط التفصيلي

### القوائم المحددة (Enums)

#### Role (أدوار المستخدمين)
```
enum Role {
  CLIENT    // عميل
  PROVIDER  // مقدم خدمة
  ADMIN     // مدير النظام
}
```

#### RequestStatus (حالات الطلب)
```
enum RequestStatus {
  OPEN         // مفتوح
  IN_PROGRESS  // قيد التنفيذ
  COMPLETED    // مكتمل
  CANCELED     // ملغي
  DISPUTE      // متنازع عليه
}
```

#### OfferStatus (حالات العرض)
```
enum OfferStatus {
  PENDING    // بانتظار الموافقة
  ACCEPTED   // مقبول
  REJECTED   // مرفوض
}
```

#### DisputeStatus (حالات النزاع)
```
enum DisputeStatus {
  OPEN       // مفتوح
  RESOLVED   // تم الحل
  CLOSED     // مغلق
}
```

### الجداول الرئيسية

#### 1. User (المستخدمين)
يمثل هذا الجدول جميع المستخدمين في النظام سواء كانوا عملاء أو مقدمي خدمات أو مدراء.

| الحقل       | النوع      | الوصف                        |
|-------------|------------|------------------------------|
| id          | Int        | المعرف الفريد (مفتاح أساسي)  |
| role        | Role       | دور المستخدم                 |
| name        | String     | اسم المستخدم                 |
| email       | String     | البريد الإلكتروني (فريد)     |
| phone       | String?    | رقم الهاتف (اختياري، فريد)   |
| password    | String     | كلمة المرور (مشفرة)          |
| city        | String?    | المدينة (اختياري)            |
| createdAt   | DateTime   | تاريخ الإنشاء                |
| updatedAt   | DateTime   | تاريخ آخر تحديث              |

**العلاقات**:
- لديه `requests[]` (إذا كان عميل)
- لديه `offers[]` (إذا كان مقدم خدمة)
- لديه `messagesFrom[]` و `messagesTo[]` (الرسائل المرسلة والمستلمة)
- لديه `ratingsFrom[]` و `ratingsTo[]` (التقييمات المرسلة والمستلمة)
- لديه `disputesClient[]` و `disputesProvider[]` (النزاعات كعميل ومقدم خدمة)
- لديه `providerDocs[]` (وثائق مقدم الخدمة)

#### 2. Service (الخدمات)
يمثل أنواع الخدمات المتاحة في النظام.

| الحقل       | النوع      | الوصف                        |
|-------------|------------|------------------------------|
| id          | Int        | المعرف الفريد (مفتاح أساسي)  |
| name        | String     | اسم الخدمة                   |
| createdAt   | DateTime   | تاريخ الإنشاء                |
| updatedAt   | DateTime   | تاريخ آخر تحديث              |

**العلاقات**:
- لديه `requests[]` (طلبات هذه الخدمة)

#### 3. Request (الطلبات)
طلبات الخدمة التي ينشئها العملاء.

| الحقل         | النوع          | الوصف                      |
|---------------|----------------|----------------------------|
| id            | Int            | المعرف الفريد (مفتاح أساسي)|
| clientId      | Int            | معرف العميل                |
| serviceId     | Int            | معرف الخدمة                |
| description   | String         | وصف الطلب                  |
| budget        | Decimal?       | الميزانية (اختياري)        |
| status        | RequestStatus  | حالة الطلب                 |
| escrowAmount  | Decimal?       | المبلغ المحجوز (Escrow)    |
| createdAt     | DateTime       | تاريخ الإنشاء              |
| updatedAt     | DateTime       | تاريخ آخر تحديث            |

**العلاقات**:
- ينتمي إلى `client` (User)
- ينتمي إلى `service` (Service)
- لديه `offers[]` (العروض المقدمة)
- لديه `messages[]` (الرسائل المتعلقة بالطلب)
- قد يكون لديه `dispute` (نزاع)
- لديه `ratings[]` (التقييمات المتعلقة بالطلب)

#### 4. Offer (العروض)
العروض المقدمة من مقدمي الخدمات على طلبات العملاء.

| الحقل           | النوع         | الوصف                      |
|-----------------|---------------|----------------------------|
| id              | Int           | المعرف الفريد (مفتاح أساسي)|
| requestId       | Int           | معرف الطلب                 |
| providerId      | Int           | معرف مقدم الخدمة           |
| proposedPrice   | Decimal?      | السعر المقترح              |
| proposedDays    | Int?          | عدد الأيام المقترحة للتنفيذ|
| status          | OfferStatus   | حالة العرض                 |
| createdAt       | DateTime      | تاريخ الإنشاء              |
| updatedAt       | DateTime      | تاريخ آخر تحديث            |

**العلاقات**:
- ينتمي إلى `request` (Request)
- ينتمي إلى `provider` (User)

#### 5. Message (الرسائل)
رسائل الدردشة بين العميل ومقدم الخدمة.

| الحقل        | النوع      | الوصف                        |
|--------------|------------|------------------------------|
| id           | Int        | المعرف الفريد (مفتاح أساسي)  |
| requestId    | Int        | معرف الطلب                   |
| fromUserId   | Int        | معرف المرسل                  |
| toUserId     | Int        | معرف المستلم                 |
| content      | String     | محتوى الرسالة                |
| createdAt    | DateTime   | تاريخ الإنشاء                |

**العلاقات**:
- ينتمي إلى `request` (Request)
- ينتمي إلى `fromUser` (User)
- ينتمي إلى `toUser` (User)

#### 6. Rating (التقييمات)
تقييمات المستخدمين لبعضهم البعض بعد انتهاء الطلب.

| الحقل        | النوع      | الوصف                        |
|--------------|------------|------------------------------|
| id           | Int        | المعرف الفريد (مفتاح أساسي)  |
| fromUserId   | Int        | معرف المقيم                  |
| toUserId     | Int        | معرف المقيَّم                |
| requestId    | Int        | معرف الطلب                   |
| score        | Int        | الدرجة (من 1 إلى 5)          |
| comment      | String?    | تعليق (اختياري)              |
| createdAt    | DateTime   | تاريخ الإنشاء                |

**العلاقات**:
- ينتمي إلى `fromUser` (User)
- ينتمي إلى `toUser` (User)
- ينتمي إلى `request` (Request)

#### 7. Dispute (النزاعات)
النزاعات حول طلبات معينة.

| الحقل        | النوع         | الوصف                        |
|--------------|---------------|------------------------------|
| id           | Int           | المعرف الفريد (مفتاح أساسي)  |
| requestId    | Int           | معرف الطلب                   |
| clientId     | Int           | معرف العميل                  |
| providerId   | Int           | معرف مقدم الخدمة             |
| reason       | String        | سبب النزاع                   |
| status       | DisputeStatus | حالة النزاع                  |
| resolution   | String?       | قرار الحل (اختياري)          |
| createdAt    | DateTime      | تاريخ الإنشاء                |
| updatedAt    | DateTime      | تاريخ آخر تحديث              |

**العلاقات**:
- ينتمي إلى `request` (Request)
- ينتمي إلى `client` (User)
- ينتمي إلى `provider` (User)

#### 8. ProviderDoc (وثائق مقدم الخدمة)
وثائق ونماذج أعمال لتوثيق مقدم الخدمة.

| الحقل        | النوع      | الوصف                        |
|--------------|------------|------------------------------|
| id           | Int        | المعرف الفريد (مفتاح أساسي)  |
| userId       | Int        | معرف المستخدم (مقدم الخدمة)  |
| docURL       | String     | رابط الوثيقة/الملف           |
| verified     | Boolean    | حالة التحقق                  |
| createdAt    | DateTime   | تاريخ الإنشاء                |
| updatedAt    | DateTime   | تاريخ آخر تحديث              |

**العلاقات**:
- ينتمي إلى `user` (User)

## العلاقات بين الجداول

### علاقات User

- **User → Request**: علاقة واحد إلى متعدد (1-N) - المستخدم كعميل يمكن أن ينشئ عدة طلبات
- **User → Offer**: علاقة واحد إلى متعدد (1-N) - المستخدم كمقدم خدمة يمكن أن يقدم عدة عروض
- **User → Message (fromUser)**: علاقة واحد إلى متعدد (1-N) - المستخدم يمكن أن يرسل عدة رسائل
- **User → Message (toUser)**: علاقة واحد إلى متعدد (1-N) - المستخدم يمكن أن يستقبل عدة رسائل
- **User → Rating (fromUser)**: علاقة واحد إلى متعدد (1-N) - المستخدم يمكن أن يقدم عدة تقييمات
- **User → Rating (toUser)**: علاقة واحد إلى متعدد (1-N) - المستخدم يمكن أن يستقبل عدة تقييمات
- **User → Dispute (client)**: علاقة واحد إلى متعدد (1-N) - المستخدم كعميل يمكن أن يفتح عدة نزاعات
- **User → Dispute (provider)**: علاقة واحد إلى متعدد (1-N) - المستخدم كمقدم خدمة يمكن أن يكون طرفاً في عدة نزاعات
- **User → ProviderDoc**: علاقة واحد إلى متعدد (1-N) - المستخدم كمقدم خدمة يمكن أن يقدم عدة وثائق

### علاقات Request

- **Request → User**: علاقة متعدد إلى واحد (N-1) - الطلب ينتمي لعميل واحد
- **Request → Service**: علاقة متعدد إلى واحد (N-1) - الطلب يتعلق بخدمة واحدة
- **Request → Offer**: علاقة واحد إلى متعدد (1-N) - الطلب يمكن أن يحصل على عدة عروض
- **Request → Message**: علاقة واحد إلى متعدد (1-N) - الطلب يمكن أن يحتوي على عدة رسائل
- **Request → Dispute**: علاقة واحد إلى واحد (1-1) - الطلب يمكن أن يكون فيه نزاع واحد
- **Request → Rating**: علاقة واحد إلى متعدد (1-N) - الطلب يمكن أن يحصل على عدة تقييمات

## ملاحظات إضافية

- تم تصميم قاعدة البيانات لتوفير خصوصية الأسعار بين العميل ومقدم الخدمة، بحيث يمكن للمشرف إضافة هامش ربح.
- تم استخدام نظام Escrow (الضمان) لحجز المبالغ حتى اكتمال العمل.
- يحتاج الحقل `password` إلى تشفير قبل حفظه في قاعدة البيانات.
- يمكن توسيع النظام مستقبلاً بإضافة جداول إضافية مثل `ProviderServices` لربط مقدمي الخدمة بأكثر من تخصص.

## مخطط العلاقات

```
User 1--N Request
User 1--N Offer
User 1--N Message
User 1--N Rating
User 1--N Dispute
User 1--N ProviderDoc

Service 1--N Request

Request 1--1 Dispute (Optional)
Request 1--N Offer
Request 1--N Message
Request 1--N Rating
``` 